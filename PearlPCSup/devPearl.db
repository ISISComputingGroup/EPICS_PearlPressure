record(bo, "$(P)$(IOC_NAME)DISABLE"){
    field(DESC, "Disable comms")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
    field(OMSL, "supervisory")
    field(ZNAM, "COMMS ENABLED")
    field(ONAM, "COMMS DISABLED")
}

record(calc, "$(P)$(IOC_NAME)BUFFER1"){
    field(DESC, "Buffer 1 status values A-K")
    field(CALC, "0")
    field(INPL, "$(P)$(IOC_NAME)STATUS")
    field(FLNK, "$(P)$(IOC_NAME)BUFFER2")
}

record(calc, "$(P)$(IOC_NAME)BUFFER2"){
    field(DESC, "Buffer 2 status values A-D")
    field(CALC, "0")
    field(INPL, "$(P)$(IOC_NAME)STATUS")
}

# record(scalcout, "$(P)$(IOC_NAME)BUFFER1"){
#     field(DESC, "Buffer 1 status values A-K")
#     field(CALC, "L = A + B + C + D + E + F + G + H + I + J + K")
#     field(INPL, "$(P)$(IOC_NAME)STATUS")
#     field(FLNK, "$(P)$(IOC_NAME)BUFFER2")
# }

# record(scalcout, "$(P)$(IOC_NAME)BUFFER2"){
#     field(DESC, "Buffer 2 status values A-D")
#     field(CALC, "L = A + B + C + D + E + F + G + H + I + J + K")
#     field(INPL, "$(P)$(IOC_NAME)STATUS")
# }

record(ai, "$(P)$(IOC_NAME)STATUS"){
    field(DESC, "Get Pressure Device Status")
    field(DTYP, "stream")
    field(INP, "@PearlPC.proto get_st($(P)$(IOC_NAME)BUFFER1, $(P)$(IOC_NAME)BUFFER2) $(PORT)")
    field(SCAN, "1 second")
    field(FLNK, "$(P)$(IOC_NAME)BUFFER1")
}

record(waveform, "$(P)$(IOC_NAME)record_name") {
    field(DESC, "Return status")
    field(DTYP, "stream")
    field(INP, "@PearlPC.proto get_st_array $(PORT)")
    field(NELM, "15")
    field(SCAN, "1 second")
    field(FTVL, "DOUBLE")
}

# record(aai, "$(P)$(IOC_NAME)STATUS"){
#     field(DESC, "Get Pressure Device Status")
#     field(DTYP, "stream")
#     field(NELM, "14")
#     field(FTVL, "SHORT")
#     field(INP, "@PearlPC.proto get_st($(P)$(IOC_NAME)BUFFER1, $(P)$(IOC_NAME)BUFFER2) $(PORT)")
#     field(SCAN, "1 second")
#     field(FLNK, "$(P)$(IOC_NAME)BUFFER1")
# }

# 

record(ao, "$(P)$(IOC_NAME)SI_PRESSURE:SP"){
    field(DESC, "Set initial ID prefix")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_si $(PORT)")
}

record(ao, "$(P)$(IOC_NAME)SD_PRESSURE:SP"){
    field(DESC, "Set secondary ID prefix")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_sd $(PORT)")
}

record(stringin, "$(P)$(IOC_NAME)ID_PRESSURE") {
    field(DESC, "Get ID prefix")
    field(DTYP, "stream")
    field(INP, "@PearlPC.proto get_id $(PORT)")
    field(SCAN, "1 second")
}

record(bo, "$(P)$(IOC_NAME)EM_PRESSURE:SP") {
    field(DESC, "EM stop circuit status")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_EM $(PORT)")
    field(ZNAM, "Start")
    field(ONAM, "Stop")
}

record(bi, "$(P)$(IOC_NAME)EM_PRESSURE"){
    field(INP, "$(P)$(IOC_NAME)BUFFER1.A CP MS")
    field(DESC,  "EM stop circuit status")
    field(DTYP, "Soft Channel")
    field(ZNAM, "Start")
    field(ONAM, "Stop")
}

record(bo, "$(P)$(IOC_NAME)RU_PRESSURE:SP") {
    field(DESC, "Set Mechanically active status")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_ru $(PORT)")
    field(ZNAM, "Start")
    field(ONAM, "Stop")
}

record(bi, "$(P)$(IOC_NAME)RU_PRESSURE"){
    field(DESC, "Get Mechanically active status")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.B CP MS")
    field(DTYP, "Soft Channel")
    field(ZNAM, "Start")
    field(ONAM, "Stop")
}

record(ao, "$(P)$(IOC_NAME)RE_PRESSURE:SP") {
    field(DESC, "Reset stage for each piston")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_re $(PORT)")
    field(FLNK, "$(P)$(IOC_NAME)RE_PRESSURE CP")
}

record(ai, "$(P)$(IOC_NAME)RE_PRESSURE"){
    field(DESC, "Reset stage for each piston")
    field(INP, "$(P)$(IOC_NAME)RE_PRESSURE:SP")
    # field(INP, "$(P)$(IOC_NAME)BUFFER1.C CP MS")
    field(DTYP, "Soft Channel")
}

record(bo, "$(P)$(IOC_NAME)St_PRESSURE:SP") {
    field(DESC, "Stop bit after each move/manually")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_St $(PORT)")
    field(ZNAM, "Running")
    field(ONAM, "Stopped")
}

record(bi, "$(P)$(IOC_NAME)St_PRESSURE"){
    field(DESC, "Stop bit after each move/manually")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.D CP MS")
    field(DTYP, "Soft Channel")
    field(ZNAM, "Running")
    field(ONAM, "Stopped")
}

record(bo, "$(P)$(IOC_NAME)BY_PRESSURE:SP") {
    field(DESC, "Set Busy bit if busy or not")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_by $(PORT)")
    field(ZNAM, "Inactive")
    field(ONAM, "Active")
}

record(bi, "$(P)$(IOC_NAME)BY_PRESSURE"){
    field(DESC, "Get Busy bit if busy or not")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.E CP MS")
    field(DTYP, "Soft Channel")
    field(ZNAM, "Inactive")
    field(ONAM, "Active")
}

record(bo, "$(P)$(IOC_NAME)GO_PRESSURE:SP") {
    field(DESC, "Set system initiated by host status")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_GO $(PORT)")
    field(ZNAM, "FALSE")
    field(ONAM, "TRUE")
}

record(bi, "$(P)$(IOC_NAME)GO_PRESSURE"){
    field(DESC, "Get system initiated by host status")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.F CP MS")
    field(DTYP, "Soft Channel")
    field(ZNAM, "FALSE")
    field(ONAM, "TRUE")
}

record(bo, "$(P)$(IOC_NAME)AM_PRESSURE:SP") {
    field(DESC, "Sets auto/manual switch position")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_AM $(PORT)")
    field(ZNAM, "Manual")
    field(ONAM, "Auto")
}

record(bi, "$(P)$(IOC_NAME)AM_PRESSURE"){
    field(DESC, "Gets auto/manual switch position")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.G CP MS")
    field(DTYP, "Soft Channel")
    field(ZNAM, "Manual")
    field(ONAM, "Auto")
}

record(bo, "$(P)$(IOC_NAME)SL_PRESSURE:SP"){
    field(DESC, "Set toggle for loop pressure mode")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_sloop $(PORT)")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(bi, "$(P)$(IOC_NAME)SL_PRESSURE"){
    field(DESC, "Get loop pressure mode")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.H CP MS")
    field(DTYP, "Soft Channel")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(ao, "$(P)$(IOC_NAME)SF_PRESSURE:SP"){
    field(DESC, "Set Seal Fail Pressure Value")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_sf $(PORT)")
}

record(ai, "$(P)$(IOC_NAME)SF_PRESSURE"){
    field(DESC, "Get Seal Fail Pressure")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.I CP MS")
    field(DTYP, "Soft Channel")
    field(FLNK, "$(P)$(IOC_NAME)DETECT_SEAL_FAIL CP")
}

record(calcout, "$(P)$(IOC_NAME)DETECT_SEAL_FAIL") {
    field(DESC, "Detect pressure seal fail")
    field(CALC, "(A < B) && ((A - B) > C) ? 1 : 0 ; B := A")
    field(INPA, "$(P)$(IOC_NAME)PRESSURE")
    field(INPC, "$(P)$(IOC_NAME)SF_PRESSURE")
    field(OUT, "$(P)$(IOC_NAME)SF_MODE_PRESSURE CP")
}

record(bi, "$(P)$(IOC_NAME)SF_MODE_PRESSURE"){
    field(DESC, "Set Seal Fail Mode")
    field(DTYP, "Soft Channel")
    field(INP, "$(P)$(IOC_NAME)DETECT_SEAL_FAIL")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(ao, "$(P)$(IOC_NAME)ER_PRESSURE:SP") {
    field(DESC, "Last Error Code returned")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_ER $(PORT)")
}

record(ai, "$(P)$(IOC_NAME)ER_PRESSURE"){
    field(DESC, "Last Error Code returned")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.J CP MS")
    field(DTYP, "Soft Channel")
    field(FLNK, "$(P)$(IOC_NAME)GENERAL_ERROR_CHECK CP")
}

record(calcout, "$(P)$(IOC_NAME)GENERAL_ERROR_CHECK") {
    field(DESC, "Check if error code higher than 0 present")
    field(CALC, "A != 0? 1 : 0")
    field(INPA, "$(P)$(IOC_NAME)ER_PRESSURE")
    field(FLNK, "$(P)$(IOC_NAME)GENERAL_ERROR")
}

record(bi, "$(P)$(IOC_NAME)GENERAL_ERROR") {
    field(DESC, "Bool indicating if error has occured")
    field(DTYP, "Soft Channel")
    field(INP, "$(P)$(IOC_NAME)GENERAL_ERROR_CHECK")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(ao, "$(P)$(IOC_NAME)PRESSURE:SP"){
    field(DESC, "Set Pressure")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_ra $(PORT)")
    field(DRVH, "1000")
    field(DRVL, "10")
}

record(ai, "$(P)$(IOC_NAME)PRESSURE"){
    field(DESC, "Get Pressure from buffer1")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.K CP MS")
    field(DTYP, "Soft Channel")
    field(FLNK, "$(P)$(IOC_NAME)HIGH_PRESSURE_RESET_CHECK")
}

record(calc, "$(P)$(IOC_NAME)PRESSURE_COMPARISON"){
    field(DESC, "Compare pressure against previous val")
    field(SCAN, "1 second")
    field(CALC, "A - B; B := A")
    field(INPA, "$(P)$(IOC_NAME)PRESSURE CP")
    field(FLNK, "$(P)$(IOC_NAME)PRESSURE_FANOUT")
}

record(fanout, "$(P)$(IOC_NAME)PRESSURE_FANOUT") {
    field(DESC, "Fanout to decrease and increase calcs")
    field(LNK1, "$(P)$(IOC_NAME)DECREASING_PRESSURE_CHECK")
    field(LNK2, "$(P)$(IOC_NAME)INCREASING_PRESSURE_CHECK")
}

record(calcout, "$(P)$(IOC_NAME)DECREASING_PRESSURE_CHECK") {
    field(DESC, "Check if pressure is decreasing")
    field(CALC, "A < 0 ? 1 : 0")
    field(INPA, "$(P)$(IOC_NAME)PRESSURE_COMPARISON")
    field(FLNK, "$(P)$(IOC_NAME)DECREASING_PRESSURE")
}

record(bi, "$(P)$(IOC_NAME)DECREASING_PRESSURE") {
    field(DESC, "Pressure decreasing")
    field(ZNAM, "Nominal")
    field(ONAM, "Decreasing")
    field(INP,  "$(P)$(IOC_NAME)DECREASING_PRESSURE_CHECK")
}

record(calcout, "$(P)$(IOC_NAME)INCREASING_PRESSURE_CHECK") {
    field(DESC, "Check if pressure is increasing")
    field(CALC, "A > 0 ? 1 : 0")
    field(INPA, "$(P)$(IOC_NAME)PRESSURE_COMPARISON")
    field(FLNK, "$(P)$(IOC_NAME)INCREASING_PRESSURE")
}

record(bi, "$(P)$(IOC_NAME)INCREASING_PRESSURE") {
    field(DESC, "Pressure increasing")
    field(ZNAM, "Nominal")    
    field(ONAM, "Increasing")  
    field(INP,  "$(P)$(IOC_NAME)INCREASING_PRESSURE_CHECK")
}

record(ao, "$(P)$(IOC_NAME)MN_PRESSURE:SP"){
    field(DESC, "Set Min Pressure Value")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_mn $(PORT)")
    field(FLNK, "$(P)$(IOC_NAME)MN_PRESSURE_FANOUT CP")
}

record(dfanout, "$(P)$(IOC_NAME)MN_PRESSURE_FANOUT") {
    field(DESC, "dfanout min Pressure value")
    field(OUTA, "$(P)$(IOC_NAME)PRESSURE:SP.DRVL")
    field(DOL,  "$(P)$(IOC_NAME)MN_PRESSURE:SP")
    field(OMSL, "closed_loop")
    field(FLNK, "$(P)$(IOC_NAME)PRESSURE:SP")
}

record(ai, "$(P)$(IOC_NAME)MN_PRESSURE"){
    field(DESC, "Get Min Pressure")
    field(INP, "$(P)$(IOC_NAME)BUFFER2.A CP MS")
    field(DTYP, "Soft Channel")
}

record(ao, "$(P)$(IOC_NAME)SP_PRESSURE:SP"){
    field(DESC, "Set Setpoint Pressure Value")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_sp $(PORT)")
}

record(ai, "$(P)$(IOC_NAME)SP_PRESSURE"){
    field(DESC, "Get Setpoint Pressure")
    field(INP, "$(P)$(IOC_NAME)BUFFER2.B CP MS")
    field(DTYP, "Soft Channel")
}

record(ao, "$(P)$(IOC_NAME)MX_PRESSURE:SP"){
    field(DESC, "Set Max Pressure Value")
    field(DTYP, "stream")
    field(OUT, "@PearlPC.proto set_mx $(PORT)")
    field(FLNK, "$(P)$(IOC_NAME)MX_PRESSURE_FANOUT PP")
}

record(dfanout, "$(P)$(IOC_NAME)MX_PRESSURE_FANOUT") {
    field(DESC, "dfanout max Pressure value")
    field(OUTA, "$(P)$(IOC_NAME)PRESSURE:SP.DRVH")
    field(DOL,  "$(P)$(IOC_NAME)MX_PRESSURE:SP")
    field(OMSL, "closed_loop")
}

record(ai, "$(P)$(IOC_NAME)MX_PRESSURE"){
    field(DESC, "Get Max Pressure")
    field(INP, "$(P)$(IOC_NAME)BUFFER2.C CP MS")
    field(DTYP, "Soft Channel")
}

record(bo, "$(P)$(IOC_NAME)RESET_PRESSURE:SP") {
    field(DESC, "Return pistons to open/closed")
    field(DTYP, "Soft Channel")
    field(OUT, "@PearlPC.proto set_reset_pistons $(PORT)")
    field(ZNAM, "RESET")
    field(ONAM, "RESETTING")
    field(FLNK, "$(P)$(IOC_NAME)RESET_PRESSURE_STATUS CP")
}

record(calcout, "$(P)$(IOC_NAME)RESET_PRESSURE_STATUS") {
    field(DESC, "Check pressure is < 100 bar to reset")
    field(CALC, "(B = 1) && (A < 100) ? 1 : 0")
    field(INPA, "$(P)$(IOC_NAME)PRESSURE")
    field(INPB, "$(P)$(IOC_NAME)RESET_PRESSURE:SP")
    field(FLNK, "$(P)$(IOC_NAME)RESET_PRESSURE CP")
}

record(bi, "$(P)$(IOC_NAME)RESET_PRESSURE") {
    field(DESC, "Return pistons to open/closed")
    field(INP, "$(P)$(IOC_NAME)RESET_PRESSURE_STATUS")
    field(ZNAM, "RESET")
    field(ONAM, "RESETTING")
}

record(calcout, "$(P)$(IOC_NAME)HIGH_PRESSURE_RESET_CHECK") {
    field(DESC, "Check pressure is < 100 bar to reset")
    field(CALC, "(A < 100) ? 0 : 1")
    field(INPA, "$(P)$(IOC_NAME)PRESSURE")
    field(FLNK, "$(P)$(IOC_NAME)RESET_PRESSURE_TOO_HIGH CP")
}

record(bi, "$(P)$(IOC_NAME)RESET_PRESSURE_TOO_HIGH") {
    field(DESC, "Pressure too high to reset")    
    field(INP, "$(P)$(IOC_NAME)HIGH_PRESSURE_RESET_CHECK")
    field(ZNAM, "LOW")
    field(ONAM, "HIGH")
}

# THis record is currently not processed
# The device should populate this PV after reset command set to 1
record(mbbi, "$(P)$(IOC_NAME)PRESSURE_RESTART_STAGES") {
    field(DESC, "Get stage of pressure restart")
    field(INP, "$(P)$(IOC_NAME)BUFFER1.C CP MS")
    field(ZRST, "Not Resetting or Purging")            field(ZRVL, "0")
    field(ONST, "Reset complete – now power down!")    field(ONVL, "1")
    field(TWST, "Resetting")                           field(TWVL, "2")
    field(THST, "Purge done")                          field(THVL, "3")
    field(FRST, "Purging")                             field(FRVL, "4")
}

record(calcout, "$(P)$(IOC_NAME)READY_STATE_CHECKS") {
    field(DESC, "Ready state check validation")
    field(CALC, "(!A & !B & !C & !D & !E & !F)? 1:0")
    field(INPA, "$(P)$(IOC_NAME)RESET_PRESSURE") # Not restarting must be 0
    field(INPB, "$(P)$(IOC_NAME)SF_MODE_PRESSURE") # Not in Seal fail must be 0/RVAl OFF
    field(INPC, "$(P)$(IOC_NAME)ER_PRESSURE") # General error must be 0
    field(INPE, "$(P)$(IOC_NAME)INCREASING_PRESSURE") # Must be 0 - no increase
    field(INPF,  "$(P)$(IOC_NAME)DECREASING_PRESSURE") # Must be 0 - no decrease
    field(FLNK, "$(P)$(IOC_NAME)READY_STATE CP")
    field(SCAN, "1 second")
}

record(bi, "$(P)$(IOC_NAME)READY_STATE") {
    field(DESC, "Ready for operation in man/auto")
    field(INP, "$(P)$(IOC_NAME)READY_STATE_CHECKS")
    field(ZNAM, "NOT READY")
    field(ONAM, "READY")
}